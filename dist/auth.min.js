!function(e){"use strict";e.module("nb.auth",["ui.router","ngStorage"]).provider("$auth",["$httpProvider",function(t){var n=this,a=null,r=900,u="",o="",i=!0,c=null,m={check:401,expiration:403},s={auth:{name:"",params:{},options:{}},main:{name:"",params:{},options:{}},excluded:[]},d={},h=e.identity,l=!1,f="X-Auth-Token",p="X-Auth-Remember",_=!1;n.setData=function(e){a=e},n.setCondition=function(e){return c=e,n},n.setMapSource=function(e){return h=e,n},n.setStateAuth=function(e,t,a){return s.auth.name=e||"",s.auth.params=t||{},s.auth.options=a||{},n},n.setStateMain=function(e,t,a){return s.main.name=e||"",s.main.params=t||{},s.main.options=a||{},n},n.setExcluded=function(e){return e.excluded=e,n},n.addExcluded=function(e){return s.excluded.push(e),n},n.setAuthUrl=function(e){return u=e,n},n.setCheckUrl=function(e){return o=e,n},n.setExpiration=function(e){return r=e,n},n.setStatusCheck=function(e){return m.check=e,n},n.setStatusExpiration=function(e){return m.expiration=e,n},n.setHeaderName=function(e){return f=e,n},n.setRememberName=function(e){return p=e,n},n.addHeader=function(e,t){d[e]=t};var g;t.interceptors.push(["$q",function(e){return{request:function(e){return g.handleRequest&&-1==e.url.indexOf(o)?g.handleRequest(e):e},responseError:function(t){return e.reject(g.handleResponseError?g.handleResponseError(t):t)}}}]),n.$get=["$rootScope","$rootElement","$sessionStorage","$localStorage","$http","$interval","$q","$state","$transitions","$config",function(n,v,b,$,x,A,k,T,w,E){var y={loading:e.noop,done:e.noop},R=function(){return!0===$[E.auth.remember_name]?$:b},S=function(t){if(g.isAuthenticated()&&!$[E.auth.remember_name]){var u=(new Date).getTime(),o=Math.floor((u-(R()[E.auth.last_action_name]||0))/1e3);return g.isAuthenticated()&&o>=r?(t&&t.abort(),n.$emit("$auth.expired",{lastAction:R()[E.auth.last_action_name],timespan:o,data:e.copy(a)}),L(),0):u}return 0},D=function(){g.isAuthenticated()&&!$[E.auth.remember_name]&&(R()[E.auth.last_action_name]=(new Date).getTime())},q=function(){if(g.isAuthenticated()&&!$[E.auth.remember_name]){var t=(new Date).getTime(),r=Math.floor((t-(R()[E.auth.last_action_name]||0))/1e3);n.$emit("$auth.expired",{lastAction:R()[E.auth.last_action_name],timespan:r,data:e.copy(a)}),L()}},C=function(e){""!=o&&g.isAuthenticated()&&(l||(l=!0,x.get(o).then(function(t){g.handleResponseError(t,e)},function(t){g.handleResponseError(t,e)}).finally(function(){l=!1})))},j=function(e){R()[E.auth.header_name]=e},M=function(){delete $[E.auth.header_name],delete b[E.auth.header_name]};R()[E.auth.last_action_name]||(R()[E.auth.last_action_name]=(new Date).getTime()),$[E.auth.remember_name]||($[E.auth.remember_name]=!1),g=function(t){return t&&e.isObjectType(t)&&g.update(t),g.data()},Object.defineProperty(g,"authToken",{set:function(e){throw"It is not allowed to set auth token from service!"},get:function(){return R()[E.auth.header_name]},enumerable:!0}),g.clone=function(){return e.copy(g.data())},g.getStateAuth=function(){return s.auth},g.getStateMain=function(){return s.main},g.getExcluded=function(){return s.excluded},g.handleRequest=function(e){return R()[E.auth.last_action_name]=(new Date).getTime(),e},g.handleResponseError=function(e,t){return t&&t.abort(),e.status==m.check?g.clear():e.status==m.expiration&&q(),e},g.setRemember=function(e){return $[E.auth.remember_name]=!!e,t.defaults.headers.common[p]=$[E.auth.remember_name],g},g.getRemember=function(){return $[E.auth.remember_name]},g.data=function(){return a},g.isAuthenticated=function(){return null!=a},g.loading=function(t){return y.loading=t||e.noop,g},g.done=function(t){return y.done=t||e.noop,g},g.isExpired=function(){var e=(new Date).getTime(),t=parseInt((e-(R()[E.auth.last_action_name]||0))/1e3);return g.isAuthenticated()&&!$[E.auth.remember_name]&&(!a||t>=r)},g.update=function(e){return g.isAuthenticated()&&(a=e,n.$emit("$auth.update",a)),g},g.quick=function(r){var u=r.headers();(u&&void 0!=u[f]||void 0!=u[f.toLowerCase()])&&(j(u[f]||u[f.toLowerCase()]||""),t.defaults.headers.common[f]=g.authToken),R()[E.auth.last_action_name]=(new Date).getTime(),a=(h||e.identity)(r.data),n.$emit("$auth.authenticate",a)},g.authenticate=function(r){y.loading();var o=k.defer(),i={},m=v.injector();return e.forEach(d,function(t,n){e.isArray(t)?i[n]=m.invoke(t):i[n]=t}),x.post(u,r,{headers:i}).then(function(r){if(!0===(null===c||c(r))){var u=r.headers();void 0==u[f]&&void 0==u[f.toLowerCase()]||(j(u[f]||u[f.toLowerCase()]||""),t.defaults.headers.common[f]=g.authToken),R()[E.auth.last_action_name]=(new Date).getTime(),a=(h||e.identity)(r.data),o.resolve(r.data||{}),n.$emit("$auth.authenticate",a)}else o.reject(r.data||{});y.done()}),o.promise},g.clear=function(e){var t=[];return e&&t.push(e(g)),k.all(t).then(function(){var e=L();n.$emit("$auth.clear",e)})},g.capture=function(){_||(_=!0,w.onStart({},function(e){var t=e.to();O(e,t)}),e.element(document.body).on("click",D))},g.isAuthenticated()&&g.authToken&&(t.defaults.headers.common[f]=g.authToken),t.defaults.headers.common[p]=$[E.auth.remember_name];var L=function(){var n=e.copy(a);return a=null,delete $[E.auth.remember_name],delete $[E.auth.last_action_name],delete b[E.auth.last_action_name],M(),delete t.defaults.headers.common[f],delete t.defaults.headers.common[p],n},O=function(e,t){if(-1==s.excluded.indexOf(t.name)){var n=g.isAuthenticated();if(""!=s.auth.name&&""!=s.main.name&&t.name==s.auth.name&&n)return e.abort(),void T.go(s.main.name,s.main.params,s.main.options);if(""!=s.auth.name&&t.name!=s.auth.name&&!n)return e.abort(),void T.go(s.auth.name,s.auth.params,s.auth.options)}};return g.capture(),w.onStart({},function(e){if(i){var t=e.to();O(e,t),R()[E.auth.last_action_name]=(new Date).getTime(),i=!1,g.isExpired()?(e.abort(),g.clear()):C(e)}else g.getRemember()||C();var n=S(e);n>0&&(R()[E.auth.last_action_name]=n)}),A(function(){S()},1e4),n.$on("$destroy",function(){e.element(document.body).off("click",D)}),g}]}])}(angular);