!function(t){"use strict";t.module("nb.auth",["ui.router","ngStorage"]).provider("$auth",["$httpProvider",function(e){var n=this,a=900,u="",r="",o=!0,i=null,c={check:401,expiration:403},h={auth:{name:"",params:{},options:{}},main:{name:"",params:{},options:{}},excluded:[]},s={},d=t.identity,m=!1,f="X-Auth-Token",l="X-Auth-Remember",p=!1;n.setCondition=function(t){return i=t,n},n.setMapSource=function(t){return d=t,n},n.setStateAuth=function(t,e,a){return h.auth.name=t||"",h.auth.params=e||{},h.auth.options=a||{},n},n.setStateMain=function(t,e,a){return h.main.name=t||"",h.main.params=e||{},h.main.options=a||{},n},n.setExcluded=function(t){return t.excluded=t,n},n.addExcluded=function(t){return h.excluded.push(t),n},n.setAuthUrl=function(t){return u=t,n},n.setCheckUrl=function(t){return r=t,n},n.setExpiration=function(t){return a=t,n},n.setStatusCheck=function(t){return c.check=t,n},n.setStatusExpiration=function(t){return c.expiration=t,n},n.setHeaderName=function(t){return f=t,n},n.setRememberName=function(t){return l=t,n},n.addHeader=function(t,e){s[t]=e};var A;e.interceptors.push(["$q",function(t){return{request:function(t){return A.handleRequest&&-1==t.url.indexOf(r)?A.handleRequest(t):t},responseError:function(e){return t.reject(A.handleResponseError?A.handleResponseError(e):e)}}}]),n.$get=["$rootScope","$rootElement","$sessionStorage","$localStorage","$http","$interval","$q","$state",function(n,g,v,$,D,R,b,x){var L={loading:t.noop,done:t.noop},T={change:{start:t.noop,success:t.noop}},k=function(){return!0===$.authRemember?$:v},E=function(e){if(A.isAuthenticated()&&!$.authRemember){var u=(new Date).getTime(),r=Math.floor((u-(k().authLastAction||0))/1e3);return A.isAuthenticated()&&r>=a?(e&&e.preventDefault(),n.$emit("$auth.expired",{lastAction:k().authLastAction,timespan:r,data:t.copy(k().authData)}),C(),0):u}return 0},w=function(){A.isAuthenticated()&&!$.authRemember&&(k().authLastAction=(new Date).getTime())},y=function(){if(A.isAuthenticated()&&!$.authRemember){var e=(new Date).getTime(),a=Math.floor((e-(k().authLastAction||0))/1e3);n.$emit("$auth.expired",{lastAction:k().authLastAction,timespan:a,data:t.copy(k().authData)}),C()}},S=function(t){""!=r&&A.isAuthenticated()&&(m||(m=!0,D.get(r).then(function(e){A.handleResponseError(e,t)},function(e){A.handleResponseError(e,t)}).finally(function(){m=!1})))};k().authLastAction||(k().authLastAction=(new Date).getTime()),$.authRemember||($.authRemember=!1),(A=function(e){return e&&t.isObjectType(e)&&A.update(e),A.data()}).clone=function(){return t.copy(A.data())},A.getStateAuth=function(){return h.auth},A.getStateMain=function(){return h.main},A.getExcluded=function(){return h.excluded},A.handleRequest=function(t){return k().authLastAction=(new Date).getTime(),t},A.handleResponseError=function(t,e){return e&&e.preventDefault(),t.status==c.check?A.clear():t.status==c.expiration&&y(),t},A.setRemember=function(t){return $.authRemember=!!t,e.defaults.headers.common[l]=$.authRemember,A},A.getRemember=function(){return $.authRemember},A.data=function(){return k().authData},A.isAuthenticated=function(){return!0===k().authAuthenticated},A.loading=function(e){return L.loading=e||t.noop,A},A.done=function(e){return L.done=e||t.noop,A},A.isExpired=function(){var t=(new Date).getTime(),e=parseInt((t-(k().authLastAction||0))/1e3);return A.isAuthenticated()&&!$.authRemember&&(!k().authData||e>=a)},A.update=function(t){return A.isAuthenticated()&&(k().authData=t,n.$emit("$auth.update",k().authData)),A},A.quick=function(a){var u=a.headers();(u&&void 0!=u[f]||void 0!=u[f.toLowerCase()])&&(k().authToken=u[f]||u[f.toLowerCase()]||"",e.defaults.headers.common[f]=k().authToken),k().authLastAction=(new Date).getTime(),k().authAuthenticated=!0,k().authData=(d||t.identity)(a.data),n.$emit("$auth.authenticate",k().authData)},A.authenticate=function(a){L.loading();var r=b.defer(),o={},c=g.injector();return t.forEach(s,function(e,n){t.isArray(e)?o[n]=c.invoke(e):o[n]=e}),D.post(u,a,{headers:o}).then(function(a){if(!0===(null===i||i(a))){var u=a.headers();void 0==u[f]&&void 0==u[f.toLowerCase()]||(k().authToken=u[f]||u[f.toLowerCase()]||"",e.defaults.headers.common[f]=k().authToken),k().authLastAction=(new Date).getTime(),k().authAuthenticated=!0,k().authData=(d||t.identity)(a.data),r.resolve(a.data||{}),n.$emit("$auth.authenticate",k().authData)}else r.reject(a.data||{});L.done()}),r.promise},A.clear=function(t){var e=[];return t&&e.push(t(A)),b.all(e).then(function(){var t=C();n.$emit("$auth.clear",t)})},A.capture=function(){p||(p=!0,T.change.start=n.$on("$stateChangeStart",q),t.element(document.body).on("click",w))},A.isAuthenticated()&&k().authToken&&(e.defaults.headers.common[f]=k().authToken),e.defaults.headers.common[l]=$.authRemember;var C=function(){var n=t.copy(k().authData);return k().authAuthenticated=!1,delete $.authRemember,delete $.authData,delete v.authData,delete $.authLastAction,delete v.authLastAction,delete $.authToken,delete v.authToken,delete e.defaults.headers.common[f],delete e.defaults.headers.common[l],n},q=function(t,e){if(-1==h.excluded.indexOf(e.name)){var n=A.isAuthenticated();if(""!=h.auth.name&&""!=h.main.name&&e.name==h.auth.name&&n)return t.preventDefault(),void x.go(h.main.name,h.main.params,h.main.options);if(""!=h.auth.name&&e.name!=h.auth.name&&!n)return t.preventDefault(),void x.go(h.auth.name,h.auth.params,h.auth.options)}};return A.capture(),T.change.success=n.$on("$stateChangeSuccess",function(t,e){o?(q(t,e),k().authLastAction=(new Date).getTime(),o=!1,A.isExpired()?(t.preventDefault(),A.clear()):S(t)):A.getRemember()||S();var n=E(t);n>0&&(k().authLastAction=n)}),R(function(){E()},1e4),n.$on("$destroy",function(){T.change.start(),T.change.success(),t.element(document.body).off("click",w)}),A}]}])}(angular);