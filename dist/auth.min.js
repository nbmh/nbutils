!function(a){"use strict";a.module("nb.auth",["ui.router","ngStorage"]).provider("$auth",["$httpProvider",function(b){var c=this,d=900,e=10,f="",g="",h=!0,i=null,j={check:401,expiration:403},k={auth:{name:"",params:{},options:{}},main:{name:"",params:{},options:{}},excluded:[]},l={},m=a.identity,n=!1,o="X-Auth-Token",p="X-Auth-Remember",q=!1;c.setCondition=function(a){return i=a,c},c.setMapSource=function(a){return m=a,c},c.setStateAuth=function(a,b,d){return k.auth.name=a||"",k.auth.params=b||{},k.auth.options=d||{},c},c.setStateMain=function(a,b,d){return k.main.name=a||"",k.main.params=b||{},k.main.options=d||{},c},c.setExcluded=function(a){return a.excluded=a,c},c.addExcluded=function(a){return k.excluded.push(a),c},c.setAuthUrl=function(a){return f=a,c},c.setCheckUrl=function(a){return g=a,c},c.setExpiration=function(a){return d=a,c},c.setStatusCheck=function(a){return j.check=a,c},c.setStatusExpiration=function(a){return j.expiration=a,c},c.setHeaderName=function(a){return o=a,c},c.setRememberName=function(a){return p=a,c},c.addHeader=function(a,b){l[a]=b};var r;b.interceptors.push(["$q",function(a){return{request:function(a){return r.handleRequest&&a.url.indexOf(g)==-1?r.handleRequest(a):a},responseError:function(b){return a.reject(r.handleResponseError?r.handleResponseError(b):b)}}}]),c.$get=["$rootScope","$rootElement","$sessionStorage","$localStorage","$http","$interval","$q","$state",function(c,s,t,u,v,w,x,y){var z={loading:a.noop,done:a.noop},A={change:{start:a.noop,success:a.noop}},B=function(){return u.authRemember===!0?u:t},C=function(b){if(r.isAuthenticated()&&!u.authRemember){var e=(new Date).getTime(),f=Math.floor((e-(B().authLastAction||0))/1e3);return r.isAuthenticated()&&f>=d?(b&&b.preventDefault(),c.$emit("$auth.expired",{lastAction:B().authLastAction,timespan:f,data:a.copy(B().authData)}),G(),0):e}return 0},D=function(){r.isAuthenticated()&&!u.authRemember&&(B().authLastAction=(new Date).getTime())},E=function(){if(r.isAuthenticated()&&!u.authRemember){var b=(new Date).getTime(),d=Math.floor((b-(B().authLastAction||0))/1e3);c.$emit("$auth.expired",{lastAction:B().authLastAction,timespan:d,data:a.copy(B().authData)}),G()}},F=function(a){""!=g&&r.isAuthenticated()&&(n||(n=!0,v.get(g).then(function(b){r.handleResponseError(b,a)},function(b){r.handleResponseError(b,a)})["finally"](function(){n=!1})))};B().authLastAction||(B().authLastAction=(new Date).getTime()),u.authRemember||(u.authRemember=!1),r=function(b){return b&&a.isObjectType(b)&&r.update(b),r.data()},r.getStateAuth=function(){return k.auth},r.getStateMain=function(){return k.main},r.getExcluded=function(){return k.excluded},r.handleRequest=function(a){return B().authLastAction=(new Date).getTime(),a},r.handleResponseError=function(a,b){return b&&b.preventDefault(),a.status==j.check?r.clear():a.status==j.expiration&&E(),a},r.setRemember=function(a){return u.authRemember=!!a,b.defaults.headers.common[p]=u.authRemember,r},r.getRemember=function(){return u.authRemember},r.data=function(){return B().authData},r.isAllowed=function(a){return r.isAuthenticated()&&B().authData.id&&B().authData.id===a},r.isAuthenticated=function(){return B().authAuthenticated===!0},r.loading=function(b){return z.loading=b||a.noop,r},r.done=function(b){return z.done=b||a.noop,r},r.isExpired=function(){var a=(new Date).getTime(),b=parseInt((a-(B().authLastAction||0))/1e3);return r.isAuthenticated()&&!u.authRemember&&(!B().authData||b>=d)},r.update=function(a){return r.isAuthenticated()&&(B().authData=a,c.$emit("$auth.update",B().authData)),r},r.quick=function(d){var e=d.headers();(e&&void 0!=e[o]||void 0!=e[o.toLowerCase()])&&(B().authToken=e[o]||e[o.toLowerCase()]||"",b.defaults.headers.common[o]=B().authToken),B().authLastAction=(new Date).getTime(),B().authAuthenticated=!0,B().authData=(m||a.identity)(d.data),c.$emit("$auth.authenticate",B().authData)},r.authenticate=function(d){z.loading();var e=x.defer(),g={},h=s.injector();return a.forEach(l,function(b,c){a.isArray(b)?g[c]=h.invoke(b):g[c]=b}),v.post(f,d,{headers:g}).then(function(d){var f=null===i||i(d);if(f===!0){var g=d.headers();void 0==g[o]&&void 0==g[o.toLowerCase()]||(B().authToken=g[o]||g[o.toLowerCase()]||"",b.defaults.headers.common[o]=B().authToken),B().authLastAction=(new Date).getTime(),B().authAuthenticated=!0,B().authData=(m||a.identity)(d.data),e.resolve(d.data||{}),c.$emit("$auth.authenticate",B().authData)}else e.reject(d.data||{});z.done()}),e.promise},r.clear=function(a){var b=[];return a&&b.push(a(r)),x.all(b).then(function(){var a=G();c.$emit("$auth.clear",a)})},r.capture=function(){q||(q=!0,A.change.start=c.$on("$stateChangeStart",H),a.element(document.body).on("click",D))},r.isAuthenticated()&&B().authToken&&(b.defaults.headers.common[o]=B().authToken),b.defaults.headers.common[p]=u.authRemember;var G=function(){var c=a.copy(B().authData);return B().authAuthenticated=!1,delete u.authRemember,delete u.authData,delete t.authData,delete u.authLastAction,delete t.authLastAction,delete u.authToken,delete t.authToken,delete b.defaults.headers.common[o],delete b.defaults.headers.common[p],c},H=function(a,b){if(k.excluded.indexOf(b.name)==-1){var c=r.isAuthenticated();if(""!=k.auth.name&&""!=k.main.name&&b.name==k.auth.name&&c)return a.preventDefault(),void y.go(k.main.name,k.main.params,k.main.options);if(""!=k.auth.name&&b.name!=k.auth.name&&!c)return a.preventDefault(),void y.go(k.auth.name,k.auth.params,k.auth.options)}};return r.capture(),A.change.success=c.$on("$stateChangeSuccess",function(a,b){h?(H(a,b),B().authLastAction=(new Date).getTime(),h=!1,r.isExpired()?(a.preventDefault(),r.clear()):F(a)):r.getRemember()||F();var c=C(a);c>0&&(B().authLastAction=c)}),w(function(){C()},1e3*e),c.$on("$destroy",function(){A.change.start(),A.change.success(),a.element(document.body).off("click",D)}),r}]}])}(angular);